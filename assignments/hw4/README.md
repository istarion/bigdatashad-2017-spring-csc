# Домашнее задание 4

Продолжающееся развитие социальной сети Zwitter привело к расширению штата сотрудников, занимающихся анализом данных из социальной сети: 
основатели наняли на работу аналитиков. Основной задачей аналитиков является поиск ответов на конкретные ad-hoc бизнес-запросы;
ценность представляет, в основном конечный результат анализа, а не скорость его выполнения. Аналитики привыкли использовать в своей работе SQL.

## Что надо делать?

В четвертом домашнем задании вам необходимо помочь аналитикам включиться в работу и написать им для примера набор SQL запросов.

Ниже вы можете найти более подробную информацию по следующим вопросам:

  * [Исходные данные](#Исходные-данные)
  * [Задания для запросов](#Задания)
  * [Требования](#Требования)
  * [Процесс сдачи задания](#Процесс-сдачи-задания)
  * [Критерии сдачи задания](#Критерии-сдачи-задания)

## Исходные данные

В этом задании используются те же исходные данные, что и в первом домашнем задании: логи доступа к веб-серверу.

Из каждой записи в логе можно выделить **пользователя** и **посещенный профиль**: пользователь определяется IP-адресом,
а посещенный профиль -- идентификатором, закодированном в URI запроса в виде `idNNNNN`.

К примеру, по записи

```
195.206.123.39 - - [24/Sep/2015:12:32:53 +0400] "GET /id18222 HTTP/1.1" 200 10703 "http://bing.com/" "Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.94 Safari/537.36"
```

Можно сказать, что пользователь **195.206.123.39** посетил профиль **id18222**.

Как и в первом домашнем задании, для расчета целевых метрик в запросах вам стоит рассматривать только успешные (HTTP-код 200)
запросы к веб-сайту. Неуспешные запросы стоит игнорировать.

Логи для этого задания лежат в директории на кластере: `/user/bigdatashad/hw4_logs`. Там есть несколько дней, они разложены по директориям и их удобно использовать для Hive-таблиц (см. материалы Семинара 10).

## Задания

Все задания считаются относительно одного фиксированного дня.

1. `[earliest_hit]` Напишите запрос, выводящий на экран самый ранний за день хит с лексикографически наименьшего IP адреса.
Результат: строчка из tab-separated полей: `ip`, `date` (без таймзоны), `url`, `status_code`, `referer`, `user_agent`.
Например: `100.43.79.10    17/Nov/2015:00:00:10    /id40601        200     -       Mozilla/5.0 (iPad; CPU OS 8_4_1 like Mac OS X) AppleWebKit/600.1.4 (KHTML, like Gecko) CriOS/45.0.2454.68 Mobile/12H321 Safari/600.1`

2. `[top_10_hours]` Напишите запрос, выводящий на экран TOP-10 часов в сутках с наибольшим количеством хитов. Если есть часы с одинаковым количеством хитов на границе TOP-10, то необходимо вывести наименьший час.
Результат: две tab-separated колонки: час (две цифры: 00, 01, ..., 23) и число хитов.

3. `[most_visited_profile_by_hour]` Напишите запрос, выводящий на экран для каждого часа самый посещаемый профиль. Если таких профилей несколько, то необходимо выбрать лексикографически наименьший профиль.
Результат: две tab-separated колонки: час (две цифры: 00, 01, ..., 23) и профиль (в формате `id12345`).

4. `[users_today_with_three_hits]` Напишите запрос, выводящий на экран количество пользователей, которые заходили на сайт сегодня и сделали больше 3 хитов, но не заходили ни разу вчера.

## Требования

Ваше решение должно удовлетворять следующим требованиям:

  * запросы должны быть написаны на языке HiveQL;
  * таблицы, на которых выполняются запросы, должны быть созданы в базе данных, одноименной с вашим логином;
  * написанные запросы должны честно вычислять требуемые значения, а не использовать предпосчитанные результаты.

## Процесс сдачи задания

Для самопроверки готовые запросы надо будет ввести в форму на странице: [http://hadoop2-00.yandex.ru:8888/ysda/hw4/submit](http://hadoop2-00.yandex.ru:8888/ysda/hw4/submit "submit"). Каждый запрос проверяется отдельно от других. 
Вместо даты в запросе используйте конструкцию `${DATE}`, для вчерашней даты - `${DATE_PREV}`. Они при проверке будут подменены на реальные даты в формате YYYY-MM-DD.

В ходе проверки ваш запрос будет исполнен, а результат -- сопоставлен с эталоном. На это уйдет несколько минут в зависимости от сложности запроса и загруженности кластера. Итог проверки будет появляться в интерфейсе по готовности на странице [http://hadoop2-00.yandex.ru:8888/ysda/hw4/result](http://hadoop2-00.yandex.ru:8888/ysda/hw4/result "result").

## Критерии сдачи задания

За корректно составленные запросы `earliest_hit` и `top_10_hours` выдается по два попугая за каждый. За корректные составленные запросы `most_visited_profile_by_hour` и `users_today_with_three_hits` выдается по три попугая. Суммарно в данном ДЗ можно набрать 10 попугаев.
Система проверки ведет учет ошибочных запросов: за каждые три неудачных попытки будет вычитаться по одному попугаю.
Срок выполнения задания - *до 15.05.2017 включительно*.
